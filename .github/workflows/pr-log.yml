name: PR Log

on:
  pull_request:
    types: [opened, reopened, synchronize]   # runs when a PR is opened, reopened, or synchronized

permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  log-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (for context; not strictly required)
        uses: actions/checkout@v4

      - name: Gather PR info
        id: prinfo
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "pr_title<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "pr_author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          echo "pr_head_ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          echo "pr_base_ref=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          echo "pr_url=${{ github.event.pull_request.html_url }}" >> $GITHUB_OUTPUT

      - name: Log to Actions console
        run: |
          echo "=== PR RECEIVED ==="
          echo "Number : ${{ steps.prinfo.outputs.pr_number }}"
          echo "Title  : <<<'${{ steps.prinfo.outputs.pr_title }}'>>>"
          echo "Author : ${{ steps.prinfo.outputs.pr_author }}"
          echo "Branch : ${{ steps.prinfo.outputs.pr_head_ref }} -> ${{ steps.prinfo.outputs.pr_base_ref }}"
          echo "URL    : ${{ steps.prinfo.outputs.pr_url }}"
          echo "Logged at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

      # âœ… Step 2: Fetch PR code changes (files + diffs)
      - name: Fetch PR code changes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ steps.prinfo.outputs.pr_number }}
        run: |
          echo "Fetching changed files for PR #$PR_NUMBER"

          page=1
          per_page=100
          > pr_changes.txt

          while true; do
            response=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$OWNER/$REPO/pulls/$PR_NUMBER/files?per_page=$per_page&page=$page")

            files_count=$(echo "$response" | jq length)

            if [ "$files_count" -eq 0 ]; then
              break
            fi

            echo "$response" | jq -r '.[] | 
              "FILE: \(.filename)\nSTATUS: \(.status)\n---\n\(.patch // "No diff available")\n\n"' \
              >> pr_changes.txt

            page=$((page + 1))
          done

          echo "===== PR CODE CHANGES (TRUNCATED VIEW) ====="
          head -n 200 pr_changes.txt

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install openai

      - name: Run AI PR Review and comment on PR
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_API_VERSION: ${{ secrets.OPENAI_API_VERSION }}
          OPENAI_DEPLOYMENT_MODEL: ${{ secrets.OPENAI_DEPLOYMENT_MODEL }}

          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ steps.prinfo.outputs.pr_number }}
          PR_TITLE: ${{ steps.prinfo.outputs.pr_title }}
          PR_URL: ${{ steps.prinfo.outputs.pr_url }}
          PR_AUTHOR: ${{ steps.prinfo.outputs.pr_author }}
          PR_HEAD_REF: ${{ steps.prinfo.outputs.pr_head_ref }}
          PR_BASE_REF: ${{ steps.prinfo.outputs.pr_base_ref }}
        run: node scripts/ai-pr-review.mjs

